<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cardeasy - Login</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body id="body" class="formpage">
<div id="login" class="formdiv">
  <div class="formsubdiv"><label for="email" class="forminputlabel">Email: </label><input id="email" type="text" class="forminput"> <br></div>
  <div class="formsubdiv"><label for="password" class="forminputlabel">Senha: </label><input id="password" type="text" class="forminput"> <br></div>
  <button id="submit" type="button" onclick="submitForm()" class="submitbutton">Login</button>
</div>
<script src="js/script.js"></script>
<script>
  function UserLogin(email,password) {
    this.email = email
    this.password = password
  }

  function submitForm() {
    const email = document.getElementById("email").value
    const passwd = document.getElementById("password").value
    let js = JSON.stringify(new UserLogin(email,passwd))
    loginRequest(js)
  }

  async function loginRequest(user) {
    let cookiename='token';
    fetch('http://localhost:8080/user/login', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json'
      },
      body: user,
      connection: "keep-alive"
    }).then(response => response.json()).then(data => {
      console.log('POST Request Data:', data);
      setCookie(cookiename,data.token)
    })
            .catch(error => {
              console.error('Error:', error);
            });
  }
  /*//move essas depois pra o script.js//*/
  function setCookie(cname, cvalue) {
    let now = new Date(Date.now())
    now.setDate(now.getDate()+3)
    document.cookie = cname + "=" + cvalue + ";expires=" + now.toUTCString();
  }

  function getCookie(cname) {
    let name = cname + "=";
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(';');
    for(let i = 0; i <ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(name) === 0) {
        return c.substring(name.length, c.length);
      }
    }
    console.log("CAIU!")
    return "";
  }
  function testLogin() {
    let token = getCookie('token')
    if (token.length === 0) {
      console.log('TOKEN VAZIO!!!')
    }
    fetch('http://localhost:8080/user/self', {
      method: 'GET',
      headers: {
        'Content-Type':'application/json',
        'Authorization': "Bearer " + token
      },

    }).then(response => response.json()).then(data => {
      console.log('GET Request Data:', data);
    })
            .catch(error => {
              console.error('Error:', error);
            });
  }
</script>
</body>

</html>